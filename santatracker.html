<!DOCTYPE html>
<html>
  <head>
    <title>NT Santa Tracker</title>
    <link rel="icon" type="image/png" href="./resources/photos/PacerCrop.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="manifest" href="../site.webmanifest">
    <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  	<link rel="stylesheet" type="text/css" href="./resources/css/collapsible.css"/>
    <link rel="stylesheet" type="text/css" href="./resources/css/styleSP.css"/>
    <link rel="stylesheet" type="text/css" href="./resources/css/headerSP.css"/>
    <link rel="stylesheet" type="text/css" href="./resources/css/santaSP.css"/>
    <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">
	<link href='https://fonts.googleapis.com/css?family=Hammersmith+One' rel="stylesheet"/>
	<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
	<script src = "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.css' rel='stylesheet' />
	<script src="https://d3js.org/d3.v3.min.js"></script>
  </head>
  <header>
      <h1>
	<div id="nav-placeholder">
	      </div>
      </h1>
  </header>
	
<script>
$(function(){
  $("#nav-placeholder").load("nav.html");
});
</script>
	
  <body>
    <h1 class= "spacing"> Santa Tracker </h1>
	  <div class="intro">
	<p id="iter">Welcome to the Nutty Trains Santa Tracker! Father Christmas has not yet started his journey - check back later!</p>
	<center><div id="santamap">Testy Test</div></center>
	<div id="aud"></div>
</div>
</body>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibnV0dHl0cmFpbnMiLCJhIjoiY2tuNGx3YTlhMXFlcDJ2cGNyYnJvdjc3MiJ9.muQLAtpQ9ovpOrC8xc1hOw';
	
const map = new mapboxgl.Map({
  container: 'santamap',
  style: 'mapbox://styles/mapbox/satellite-streets-v11',
  center: [20, 30],
  zoom: 1.5
});

map.addControl(new mapboxgl.FullscreenControl());

const y = []
const z1 = []
const z2 = []
const coords = []
const msg = []

d3.text("./data/santa.csv", function(data) {
    var parsedCSV = d3.csv.parseRows(data);
  	var now = new Date().getTime();
	const ell = document.createElement('div');
	ell.className = 'SantaTest2';

	setInterval(function(){
		q = new Date(`Dec ${parsedCSV[1][3]}, 2021 ${parsedCSV[1][4]}:${parsedCSV[1][5]}:00`).getTime();
		var now2 = new Date().getTime();
		var diff = Math.floor((q - now2)/1000);
		if (diff > 60) {
			document.getElementById("iter").innerHTML = `Father Christmas is getting ready!`;
		}
		else if (diff > 0) {
			document.getElementById("iter").innerHTML = `Father Christmas is about to leave! Starting in ${diff}`;
		}
	}, 1000);

	for (i = 1; i < parsedCSV.length; i++) {
	// add markers to map
	// create a HTML element for each feature
	const el = document.createElement('div');
	el.className = 'SantaTest';
	el.title = `Merry Christmas ${parsedCSV[i][0]}!`;
	coords.push(parsedCSV[i][2], parsedCSV[i][1]);
	msg.push(`Santa visited ${parsedCSV[i][0]} at ${parsedCSV[i][4]}:${parsedCSV[i][5]}. Merry Christmas, ${parsedCSV[i][0]}!`);
	console.log(`Santa visited ${parsedCSV[i][0]} at ${parsedCSV[i][4]}:${parsedCSV[i][5]}. Merry Christmas, ${parsedCSV[i][0]}!`);
	y.push(new Date(`Dec ${parsedCSV[i][3]}, 2021 ${parsedCSV[i][4]}:${parsedCSV[i][5]}:00`).getTime());
	if (i < parsedCSV.length -1){
		if (parsedCSV[i+1][0] == "Anadyr" || "Tiananmen Square" || "Tripoli" || "The Kremlin" || "London") {
			z1.push(new Date(`Dec ${parsedCSV[i][3]}, 2021 ${parsedCSV[i][4]}:${parsedCSV[i][5]}:00`).getTime());
			z2.push(parsedCSV[i+1][0]);
		}
	}
		
		
setTimeout(function(i){
	
var timer = setInterval(function(i){  
	if ((i > 0) && (i < parsedCSV.length -1)) {
		p = new Date(`Dec ${parsedCSV[i][3]}, 2021 ${parsedCSV[i][4]}:${parsedCSV[i][5]}:00`).getTime();
		q = new Date(`Dec ${parsedCSV[i][3]}, 2021 ${parsedCSV[i+1][4]}:${parsedCSV[i+1][5]}:00`).getTime();
  		var now2 = new Date().getTime();
		if (now2 - q < -30000) {
			t = Math.floor(now2 - p);
			//console.log(t);
			lng = Number(parsedCSV[i][2]) + Number(t*((parsedCSV[i+1][2] - parsedCSV[i][2])/(q - p - 30000)));
			lat = Number(parsedCSV[i][1]) + Number(t*((parsedCSV[i+1][1] - parsedCSV[i][1])/(q - p - 30000)));
			ell.title = `Ho Ho Ho! I am on my way to ${parsedCSV[i+1][0]}! Merry Christmas!`;
			document.getElementById("iter").innerHTML = `Father Christmas' next stop will be ${parsedCSV[i+1][0]} at ${parsedCSV[i+1][4]}:${parsedCSV[i+1][5]}! He has visited ${i} places so far! Merry Christmas!`;
			const elll = document.createElement('div');
			elll.className = 'SantaTest3';
			// make a marker for each feature and add it to the map
			new mapboxgl.Marker(ell)
				.setLngLat([lng, lat])
				.addTo(map);
			new mapboxgl.Marker(elll)
				.setLngLat([lng, lat])
				.addTo(map);
		}
		else if (now2 - q < 0) {
			ell.title = `Ho Ho Ho! I am at ${parsedCSV[i+1][0]}! Merry Christmas ${parsedCSV[i+1][0]}!`;
			document.getElementById("iter").innerHTML = `Father Christmas is at ${parsedCSV[i+1][0]}, place number ${i+1}! His next stop will be ${parsedCSV[i+2][0]} at ${parsedCSV[i+2][4]}:${parsedCSV[i+2][5]}! Merry Christmas!`;
			// make a marker for each feature and add it to the map
			new mapboxgl.Marker(ell)
				.setLngLat([parsedCSV[i+1][2], parsedCSV[i+1][1]])
				.addTo(map);
		}
	}
	else if (i == parsedCSV.length -1) {
	document.getElementById("iter").innerHTML = `Father Christmas has now finished his journey! Come back in 2022! Merry Christmas!`;
	document.getElementById("aud").innerHTML = ` `;
	}
}, 1000, i);
	
	// make a marker for each feature and add it to the map
	new mapboxgl.Marker(el)
		.setLngLat([coords[2*i-2],coords[2*i-1]])
		.setPopup(
			new mapboxgl.Popup({ offset: 35 , closeButton: false }) // add popups
			.setHTML(`<p>${msg[i-1]}</p>`)
		)
		.addTo(map);
}, y[i-1]-now, i);
}

for (j = 0; j < z1.length; j++) {
setTimeout(function(j){
	if (z2[j] == "Tiananmen Square") {
		document.getElementById("aud").innerHTML = `<audio controls autoplay loop><source src="./resources/audio/Chinese Anthem.mp3" type="audio/mpeg"></audio>`;
	}
	else if (z2[j] == "Tripoli") {
		document.getElementById("aud").innerHTML = `<audio controls autoplay loop><source src="./resources/audio/Tour de France - Kraftwerk 2.mp3" type="audio/mpeg"></audio>`;
	}
	else if (z2[j] == "The Kremlin") {
		document.getElementById("aud").innerHTML = `<audio controls autoplay loop><source src="./resources/audio/Commie2.5.mp3" type="audio/mpeg"></audio>`;
	}
	else if (z2[j] == "Anadyr" || "London"){
		document.getElementById("aud").innerHTML = `<audio controls autoplay loop><source src="./resources/audio/Christmas.mp3" type="audio/mpeg"></audio>`;
	}
}, z1[j]-now, j);
}

});  
</script>
</html>
