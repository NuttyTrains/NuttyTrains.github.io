<!DOCTYPE html>
<html>
  <head>
    <title>NT Santa Tracker</title>
    <link rel="icon" type="image/png" href="./resources/photos/PacerCrop.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="manifest" href="../site.webmanifest">
    <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  	<link rel="stylesheet" type="text/css" href="./resources/css/collapsible.css"/>
    <link rel="stylesheet" type="text/css" href="./resources/css/styleSP.css"/>
    <link rel="stylesheet" type="text/css" href="./resources/css/headerSP.css"/>
    <link rel="stylesheet" type="text/css" href="./resources/css/santaSP.css"/>
    <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">
	<link href='https://fonts.googleapis.com/css?family=Hammersmith+One' rel="stylesheet"/>
	<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
	<script src = "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.css' rel='stylesheet' />
	<script src="https://d3js.org/d3.v3.min.js"></script>
  </head>
  <header>
      <h1>
	<div id="nav2-placeholder">
	      </div>
      </h1>
  </header>
	
<script>
$(function(){
  $("#nav2-placeholder").load("nav2.html");
});
</script>
	
  <body>
    <h1 class= "spacing"> Santa Tracker </h1>
	  <div class="intro">
	<p>
		Welcome to the Nutty Trains Santa Tracker - going live, December 24th!
	</p>
	<center><div id="santamap">Testy Test</div></center>
	<div style="padding: 1em 1em 1em 1em;"></div>

</div>
</body>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibnV0dHl0cmFpbnMiLCJhIjoiY2tuNGx3YTlhMXFlcDJ2cGNyYnJvdjc3MiJ9.muQLAtpQ9ovpOrC8xc1hOw';
	
const map = new mapboxgl.Map({
  container: 'santamap',
  style: 'mapbox://styles/mapbox/streets-v11',
  center: [-0.1686, 51.5183],
  zoom: 12
});

const y = []
const coords = []
const msg = []

d3.text("./data/santa.csv", function(data) {
    var parsedCSV = d3.csv.parseRows(data);
  	var now = new Date().getTime();
	for (i = 1; i < parsedCSV.length; i++) {
	//for (i = 1; i < 3; i++) {
		console.log(i);
	// add markers to map
	// create a HTML element for each feature
	const el = document.createElement('div');
	el.className = 'SantaTest';
	el.title = `Merry Christmas ${parsedCSV[i][0]}!`;
	coords.push(parsedCSV[i][2], parsedCSV[i][1]);
	console.log(parsedCSV[i][2], parsedCSV[i][1]);
	msg.push(`Santa visited ${parsedCSV[i][0]} at ${parsedCSV[i][4]}:${parsedCSV[i][5]}. Merry Christmas, ${parsedCSV[i][0]}!`);
	console.log(`Santa visited ${parsedCSV[i][0]} at ${parsedCSV[i][4]}:${parsedCSV[i][5]}. Merry Christmas, ${parsedCSV[i][0]}!`);
	y.push(new Date(`Dec 1, 2021 ${parsedCSV[i][4]}:${parsedCSV[i][5]}:00`).getTime());
  	//y.push(new Date(`Nov 28, 2021 20:57:00`).getTime());
		
setTimeout(function(i){  
	// make a marker for each feature and add it to the map
	new mapboxgl.Marker(el)
		.setLngLat([coords[2*i-2],coords[2*i-1]])
		//.setLngLat([coords[0],coords[1]])
		.setPopup(
			new mapboxgl.Popup({ offset: 35 , closeButton: false }) // add popups
			.setHTML(`<p>${msg[i-1]}</p>`)
			//.setHTML(`<p>${msg[0]}</p>`)
		)
		.addTo(map);
}, y[i-1]-now, i);
}  
		

const ell = document.createElement('div');
ell.className = 'SantaTest2';
ell.title = `Ho Ho Ho!`;
	

setInterval(function(){  
let k = 1;
while (k < parsedCSV.length-1) {
	p = new Date(`Dec 1, 2021 ${parsedCSV[k][4]}:${parsedCSV[k][5]}:00`).getTime();
	q = new Date(`Dec 1, 2021 ${parsedCSV[k+1][4]}:${parsedCSV[k+1][5]}:00`).getTime();
  	var now2 = new Date().getTime();
	if (now2 - q < 0) {
		t = Math.floor(now2 - p);
		console.log(t);
		lng = parseInt(parsedCSV[k][2] + t*((parsedCSV[k+1][2] - parsedCSV[k][2])/(q - p)));
		console.log(lng);
		lat = parseInt(parsedCSV[k][1] + t*((parsedCSV[k+1][1] - parsedCSV[k][1])/(q - p)));
		console.log(lat);
		// make a marker for each feature and add it to the map
		new mapboxgl.Marker(ell)
			.setLngLat([lng, lat])
			.setPopup(
				new mapboxgl.Popup({ offset: 35 , closeButton: false }) // add popups
				.setHTML(`<p>Ho Ho Ho! Merry Christmas!</p>`)
			)
			.addTo(map);
			console.log('Santa');
	}
	else {k++;}
}
}, 10000);

});  
</script>
</html>
