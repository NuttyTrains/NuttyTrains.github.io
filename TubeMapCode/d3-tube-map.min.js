// http://www.pubmap.co.uk/ Version 1.1.0. Copyright 2019 John Walley.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],e):e((t=t||self).d3=t.d3||{},t.d3)}(this,function(t,O){"use strict";function S(t,e,n,r,a){for(var o,s,i,l,c,d="",h=t.nodes,f=Math.abs(e(1)-e(0)!=0?e(1)-e(0):n(1)-n(0)),u=Math.sqrt(2),p=[t.shiftCoords[0]*r/f,t.shiftCoords[1]*r/f],b="diagonal",m=0;m<h.length;m++)if(0<m){o=h[m],s=h[m-1];i=Math.round(s.coords[0]-o.coords[0]),l=Math.round(s.coords[1]-o.coords[1]);var g=[0,0];if(m===h.length-1&&(0==i||0==l?(0<i&&(g=[-r/(2*a*f),0]),i<0&&(g=[r/(2*a*f),0]),0<l&&(g=[0,-r/(2*a*f)]),l<0&&(g=[0,r/(2*a*f)])):(0<i&&0<l&&(g=[-r/(2*a*f*u),-r/(2*a*f*u)]),0<i&&l<0&&(g=[-r/(2*a*f*u),r/(2*a*f*u)]),i<0&&0<l&&(g=[r/(2*a*f*u),-r/(2*a*f*u)]),i<0&&l<0&&(g=[r/(2*a*f*u),r/(2*a*f*u)]))),c=[[e(s.coords[0]+p[0]),n(s.coords[1]+p[1])],[e(o.coords[0]+p[0]+g[0]),n(o.coords[1]+p[1]+g[1])]],0==i||0==l)b="udlr",d+="L"+c[1][0]+","+c[1][1];else if(Math.abs(i)==Math.abs(l)&&1<Math.abs(i))b="diagonal",d+="L"+c[1][0]+","+c[1][1];else if(1==Math.abs(i)&&1==Math.abs(l))switch(o.dir.toLowerCase()){case"e":d+="Q"+c[1][0]+","+c[0][1]+","+c[1][0]+","+c[1][1];break;case"s":case"n":d+="Q"+c[0][0]+","+c[1][1]+","+c[1][0]+","+c[1][1];break;case"w":d+="Q"+c[1][0]+","+c[0][1]+","+c[1][0]+","+c[1][1]}else if(1==Math.abs(i)&&2==Math.abs(l)||2==Math.abs(i)&&1==Math.abs(l)){var y;1==i?"udlr"==b?y=[c[0][0],c[0][1]+(c[1][1]-c[0][1])/2]:"diagonal"==b&&(y=[c[1][0],c[0][1]+(c[1][1]-c[0][1])/2]):-1==i?"udlr"==b?y=[c[0][0],c[0][1]+(c[1][1]-c[0][1])/2]:"diagonal"==b&&(y=[c[1][0],c[0][1]+(c[1][1]-c[0][1])/2]):-2==i?"udlr"==b?y=[c[0][0]+(c[1][0]-c[0][0])/2,c[0][1]]:"diagonal"==b&&(y=[c[0][0]+(c[1][0]-c[0][0])/2,c[1][1]]):2==i&&("udlr"==b?y=[c[0][0]+(c[1][0]-c[0][0])/2,c[0][1]]:"diagonal"==b&&(y=[c[0][0]+(c[1][0]-c[0][0])/2,c[1][1]])),d+="C"+y[0]+","+y[1]+","+y[0]+","+y[1]+","+c[1][0]+","+c[1][1]}}else{o=h[m+1],s=h[m],i=Math.round(s.coords[0]-o.coords[0]),l=Math.round(s.coords[1]-o.coords[1]);var k=[0,0];0==i||0==l?(0<i&&(k=[r/(2*a*f),0]),i<0&&(k=[-r/(2*a*f),0]),0<l&&(k=[0,r/(2*a*f)]),l<0&&(k=[0,-r/(2*a*f)])):(0<i&&0<l&&(k=[r/(2*a*f*u),r/(2*a*f*u)]),0<i&&l<0&&(k=[r/(2*a*f*u),-r/(2*a*f*u)]),i<0&&0<l&&(k=[-r/(2*a*f*u),r/(2*a*f*u)]),i<0&&l<0&&(k=[-r/(2*a*f*u),-r/(2*a*f*u)])),d+="M"+(c=[e(s.coords[0]+p[0]+k[0]),n(s.coords[1]+p[1]+k[1])])[0]+","+c[1]}return d}function A(t){this.lines=t}function X(t){this.stations=t}X.prototype.toArray=function(){var t=[];for(var e in this.stations)if(this.stations.hasOwnProperty(e)){var n=this.stations[e];n.name=e,t.push(n)}return t},X.prototype.interchanges=function(){return this.toArray().filter(function(t){return"interchange"===t.marker[0].marker})},X.prototype.normalStations=function(){var t=this.toArray().filter(function(t){return"interchange"!==t.marker[0].marker}),n=[];return t.forEach(function(e){e.marker.forEach(function(t){n.push({name:e.name,line:t.line,x:e.x,y:e.y,color:t.color,shiftX:t.shiftX,shiftY:t.shiftY,labelPos:e.labelPos})})}),n},t.tubeMap=function(){var f,u,p,b,m={top:80,right:80,bottom:20,left:80},g=760,y=640,k=O.scaleLinear(),w=O.scaleLinear(),v=.8,C=1.5,x=O.dispatch("click");function e(h){h.each(function(t){p=function(t){return{raw:t.lines,river:t.river,stations:function(a){return a.lines.forEach(function(t){for(var e=0;e<t.nodes.length;e++){var n=t.nodes[e];if(n.hasOwnProperty("name")){if(!a.stations.hasOwnProperty(n.name))throw new Error("Cannot find station with key: "+n.name);var r=a.stations[n.name];r.x=n.coords[0],r.y=n.coords[1],void 0===r.labelPos&&(r.labelPos=n.labelPos,r.labelShiftX=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[0]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[0]:t.shiftCoords[0],r.labelShiftY=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[1]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[1]:t.shiftCoords[1]),n.hasOwnProperty("canonical")&&(r.labelPos=n.labelPos,r.labelShiftX=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[0]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[0]:t.shiftCoords[0],r.labelShiftY=n.hasOwnProperty("labelShiftCoords")?n.labelShiftCoords[1]:n.hasOwnProperty("shiftCoords")?n.shiftCoords[1]:t.shiftCoords[1]),r.label=a.stations[n.name].label,r.position=a.stations[n.name].position,r.closed=!!a.stations[n.name].hasOwnProperty("closed")&&a.stations[n.name].closed,r.visited=!1,n.hide||(r.marker=r.marker||[],r.marker.push({line:t.name,color:t.color,labelPos:n.labelPos,marker:n.hasOwnProperty("marker")?n.marker:"station",shiftX:n.hasOwnProperty("shiftCoords")?n.shiftCoords[0]:t.shiftCoords[0],shiftY:n.hasOwnProperty("shiftCoords")?n.shiftCoords[1]:t.shiftCoords[1]}))}}}),function(t){return new X(t)}(a.stations)}(t),lines:function(t){var a=[];return t.forEach(function(t){var e={name:t.name,title:t.label,stations:[],color:t.color,shiftCoords:t.shiftCoords,nodes:t.nodes,highlighted:!1};a.push(e);for(var n=0;n<t.nodes.length;n++){var r=t.nodes[n];r.hasOwnProperty("name")&&e.stations.push(r.name)}}),function(t){return new A(t)}(a)}(t.lines)}}(t);var e,n,r=O.min(p.raw,function(t){return O.min(t.nodes,function(t){return t.coords[0]})})-1,a=O.max(p.raw,function(t){return O.max(t.nodes,function(t){return t.coords[0]})})+1,o=O.min(p.raw,function(t){return O.min(t.nodes,function(t){return t.coords[1]})})-1,s=O.max(p.raw,function(t){return O.max(t.nodes,function(t){return t.coords[1]})})+1,i=(a-r)/(s-o),l=(g-m.left-m.right)/(y-m.top-m.bottom),c=l/i;n=l<i?(e=g-m.left-m.right,(y-m.top-m.bottom)*c):(e=(g-m.left-m.right)/c,y-m.top-m.bottom),k.domain([r,a]).range([m.left,m.left+e]),w.domain([o,s]).range([m.top+n,m.top]);var d=Math.abs(k(1)-k(0)!=0?k(1)-k(0):w(1)-w(0));f=v*d,u=h.append("svg").style("width","100%").style("height","100%"),b=u.append("g"),void 0!==p.river&&b.append("g").attr("class","river").selectAll("path").data([p.river]).enter().append("path").attr("d",function(t){return S(t,k,w,f,C)}).attr("stroke","#CCECF4").attr("fill","none").attr("stroke-width",1.8*f),b.append("g").attr("class","lines").selectAll("path").data(p.lines.lines).enter().append("path").attr("d",function(t){return S(t,k,w,f,C)}).attr("id",function(t){return t.name}).attr("stroke",function(t){return t.color}).attr("fill","none").attr("stroke-width",function(t){return t.highlighted?1.3*f:f}).classed("line",!0),function(){var e="#000000",n="#ffffff";b.append("g").attr("class","interchanges").selectAll("path").data(p.stations.interchanges()).enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=O.select(this).attr("id");x.call("click",this,t)}).append("path").attr("d",function(t){return O.arc().innerRadius(0).outerRadius(1.25*t).startAngle(0).endAngle(2*Math.PI)}(f)).attr("transform",function(t){return"translate("+k(t.x+t.marker[0].shiftX*v)+","+w(t.y+t.marker[0].shiftY*v)+")"}).attr("stroke-width",f/2).attr("fill",function(t){return t.visited?e:n}).attr("stroke",function(t){return t.visited?n:e}).classed("interchange",!0).style("cursor","pointer")}(),b.append("g").attr("class","stations").selectAll("path").data(p.stations.normalStations()).enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=O.select(this).attr("id");x.call("click",this,t)}).append("path").attr("d",function(t){return function(t,e,n,r,a){var o,s=Math.sqrt(2),i=O.line().x(function(t){return e(t[0])}).y(function(t){return n(t[1])});switch(t.labelPos.toLowerCase()){case"n":o=[0,1];break;case"ne":o=[1/s,1/s];break;case"e":o=[1,0];break;case"se":o=[1/s,-1/s];break;case"s":o=[0,-1];break;case"sw":o=[-1/s,-1/s];break;case"w":o=[-1,0];break;case"nw":o=[-1/s,1/s]}return i([[t.x+t.shiftX*r+r/2.05*o[0],t.y+t.shiftY*r+r/2.05*o[1]],[t.x+t.shiftX*r+r/2*o[0]+r/a*o[0],t.y+t.shiftY*r+r/2*o[1]+r/a*o[1]]])}(t,k,w,v,C)}).attr("stroke",function(t){return t.color}).attr("stroke-width",f/C).attr("fill","none").attr("class",function(t){return t.line}).attr("id",function(t){return t.name}).classed("station",!0),b.append("g").attr("class","labels").selectAll("text").data(p.stations.toArray()).enter().append("g").attr("id",function(t){return t.name}).classed("label",!0).on("click",function(){var t=O.select(this).attr("id");x.call("click",this,t)}).append("text").text(function(t){return t.label}).attr("fill","#10137E").attr("dy",0).attr("x",function(t){return k(t.x+t.labelShiftX)+P(t).pos[0]}).attr("y",function(t){return w(t.y+t.labelShiftY)-P(t).pos[1]}).attr("text-anchor",function(t){return P(t).textAnchor}).style("display",function(t){return!0!==t.hide?"block":"none"}).style("text-decoration",function(t){return t.closed?"line-through":"none"}).style("font-size",1.96*f+"px").style("-webkit-user-select","none").attr("class",function(t){return t.marker.map(function(t){return t.line}).join(" ")}).classed("highlighted",function(t){return t.visited}).call(M,function(t){return P(t).alignmentBaseline})})}function P(t){var e,n,r,a=1.8*f,o=t.label.split(/\n/).length,s=Math.sqrt(2);switch(t.labelPos.toLowerCase()){case"n":e=[0,2.1*f*(o-1)+a],n="middle",r="baseline";break;case"ne":e=[a/s,(f*(o-1)+a)/s],n="start",r="baseline";break;case"e":e=[a,0],n="start",r="middle";break;case"se":e=[a/s,-a/s],n="start",r="hanging";break;case"s":e=[0,-v*a],n="middle",r="hanging";break;case"sw":e=[-a/s,-a/s],n="end",r="hanging";break;case"w":e=[-a,0],n="end",r="middle";break;case"nw":e=[-(f*(o-1)+a)/s,(f*(o-1)+a)/s],n="end",r="baseline"}return{pos:e,textAnchor:n,alignmentBaseline:r}}function M(t,s){t.each(function(){var t=O.select(this),e=t.text().split(/\n/),n=t.attr("y"),r=t.attr("x"),a=parseFloat(t.attr("dy"));t.text(null).append("tspan").attr("x",r).attr("y",n).attr("dy",a+"em").attr("dominant-baseline",s).text(e[0]);for(var o=1;o<e.length;o++)t.append("tspan").attr("x",r).attr("y",n).attr("dy",1.1*o+a+"em").attr("dominant-baseline",s).text(e[o])})}return e.width=function(t){return arguments.length?(g=t,e):g},e.height=function(t){return arguments.length?(y=t,e):y},e.margin=function(t){return arguments.length?(m=t,e):m},e.on=function(){var t=x.on.apply(x,arguments);return t===x?e:t},e},Object.defineProperty(t,"__esModule",{value:!0})});